enum SubscriptionStatus {
  active
  past_due
  canceled
  incomplete
  trialing
  unpaid
}

enum SubscriptionPlan {
  free
  promoted
}

enum BillingInterval {
  month
  year
}

model Subscription {
  id                     String             @id @default(cuid())
  pid                    String             @unique // One subscription per profile

  // Provider info (multi-provider support)
  provider               String             @default("stripe") // 'stripe' | 'paypal' | 'eurobank'

  // Provider-specific IDs (polymorphic - use these for new code)
  providerCustomerId     String?            @unique // Stripe customer ID, PayPal payer ID, etc.
  providerSubscriptionId String?            @unique // Stripe sub ID, PayPal sub ID, etc.

  // Legacy Stripe fields (keep for backward compatibility during migration)
  stripeCustomerId       String             @unique
  stripeSubscriptionId   String?            @unique
  stripePriceId          String?

  // Provider-agnostic subscription data
  plan                   SubscriptionPlan   @default(free)
  status                 SubscriptionStatus @default(incomplete)
  billingInterval        BillingInterval?

  // Billing details snapshot (copied from profile.billing at checkout)
  billing                Json?
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  canceledAt             DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  // Analytics fields - payment tracking
  amount                 Int?               // Current subscription amount in cents (e.g., 1999 = â‚¬19.99)
  currency               String?            @default("eur") // ISO currency code
  paymentMethodType      String?            // 'card', 'sepa_debit', 'paypal', etc.
  paymentMethodLast4     String?            // Last 4 digits of card/account
  paymentMethodBrand     String?            // 'visa', 'mastercard', 'amex', etc.

  // Lifetime analytics - cumulative tracking
  totalPaidLifetime      Int                @default(0) // Total amount paid in cents (accumulates on each payment)
  paymentCount           Int                @default(0) // Number of successful payments
  firstPaymentAt         DateTime?          // When first payment was made
  lastPaymentAt          DateTime?          // When most recent payment was made

  // Optional: discount/coupon tracking
  discountCode           String?            // If a coupon was applied
  discountPercentOff     Int?               // Percentage off (0-100)
  discountAmountOff      Int?               // Fixed amount off in cents

  profile Profile @relation(fields: [pid], references: [id], onDelete: Cascade)

  @@index([provider, providerCustomerId])
  @@index([provider, providerSubscriptionId])
  @@index([stripeCustomerId]) // Legacy index
  @@index([stripeSubscriptionId]) // Legacy index
  @@index([pid, status])
  @@map("subscriptions")
}
