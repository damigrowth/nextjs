model User {
  id              String        @id @default(cuid())
  email           String        @unique
  emailVerified   Boolean       @default(false)
  name            String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  step            String        @default("EMAIL_VERIFICATION")
  confirmed       Boolean       @default(false)
  blocked         Boolean       @default(false)
  username        String?       @unique // Keep in user for auth purposes
  displayName     String? // Keep in user for auth purposes
  firstName       String? // Keep in user for menu/auth purposes
  lastName        String? // Keep in user for menu/auth purposes
  image           String? // Profile image URL - synced from profile
  banExpires      DateTime?
  banReason       String?
  banned          Boolean       @default(false)
  type            String        @default("user") // 'user', 'pro' - for registration flow UI starts as ''
  role            String        @default("user")
  provider        String        @default("email") // email or google
  lastUnreadEmailSentAt DateTime?   // Track when last unread messages email was sent (24h cooldown)
  accounts        Account[]
  chatMemberships ChatMember[]
  chatsCreated    Chat[]
  media           Media[]
  messagesAuthored Message[]     @relation("MessageAuthor")
  messagesDeleted Message[]     @relation("MessageDeletedBy")
  profile         Profile?
  reviewsGiven    Review[]      @relation("ReviewAuthor")
  sessions        Session[]
  blockedUsers    BlockedUser[] @relation("UserBlocks")
  blockedByUsers  BlockedUser[] @relation("BlockedBy")
  savedServices   SavedService[]
  savedProfiles   SavedProfile[]
  emailBatches    EmailBatch[]

  @@index([role])
  @@index([step])
  @@index([confirmed, blocked])
  @@map("users")
}

model Profile {
  id      String  @id @default(cuid())
  uid     String  @unique
  type    String?
  tagline String?
  bio     String?
  website String?

  size        String?
  skills      String[] // Array of skill IDs from taxonomy  
  speciality  String? // Speciality ID from taxonomy
  category    String? // Service category ID from taxonomy
  subcategory String? // Service subcategory ID from taxonomy

  // Fields moved from User table
  username    String? // Duplicated from User for profile purposes
  displayName String? // Duplicated from User for profile purposes
  firstName   String? // Moved from User
  lastName    String? // Moved from User
  email       String? // Duplicated from User for profile purposes
  phone       String? // Moved from User
  /// [Coverage]
  coverage    Json? // Coverage options and location data

  // Media fields for onboarding form
  image     String? // Profile image URL
  /// [Portfolio]
  portfolio Json? // Portfolio media CloudinaryResource array

  // Presentation fields
  /// [VisibilitySettings]
  visibility Json? // Visibility settings {email, phone, address}
  /// [SocialMedia]
  socials    Json? // Social media links {facebook, instagram, linkedin, x, youtube, github, behance, dribbble}
  viber      String? // Viber contact
  whatsapp   String? // WhatsApp contact

  //  Additional fields
  rate              Int?
  commencement      String?
  experience        Int?
  contactMethods    String[]
  paymentMethods    String[]
  settlementMethods String[]
  budget            String?
  industries        String[]
  terms             String?
  /// [BillingInfo]
  billing           Json? // Billing information {receipt: boolean, invoice: boolean, afm: string, doy: string, name: string, profession: string, address: string}

  // Rate limiting fields
  lastServiceDraft DateTime? // Last time user saved a service draft

  verified        Boolean              @default(false)
  featured        Boolean              @default(false)
  rating          Float                @default(0)
  reviewCount     Int                  @default(0)
  /// [StarBreakdown]
  stars           Json? // Rating star breakdown {1: 5, 2: 10, 3: 15, 4: 20, 5: 50}
  top             Boolean              @default(false) // Top level freelancer flag
  published       Boolean              @default(false)
  isActive        Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  user            User                 @relation(fields: [uid], references: [id], onDelete: Cascade)
  reviews         Review[]             @relation("ReviewReceiver")
  services        Service[]
  verification    ProfileVerification?
  savedBy         SavedProfile[]

  @@index([uid])
  @@index([published, featured])
  @@index([verified, rating])
  @@index([category, subcategory])
  @@index([published, featured, verified])
  @@map("profiles")
}

model ProfileVerification {
  id        String   @id @default(cuid())
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  afm       String? // Greek Tax ID (AFM)
  name      String? // Full business/personal name
  address   String? // Business address
  phone     String? // Contact phone
  uid       String // User ID reference
  pid       String   @unique // Profile ID reference
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile Profile @relation(fields: [pid], references: [id], onDelete: Cascade)

  @@index([uid])
  @@index([pid])
  @@index([status])
  @@map("verifications")
}

enum UserType {
  USER
  FREELANCER
  COMPANY
}

enum JourneyStep {
  EMAIL_VERIFICATION
  ONBOARDING
  DASHBOARD
}
