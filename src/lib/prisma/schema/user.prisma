model User {
  id              String        @id @default(cuid())
  email           String        @unique
  emailVerified   Boolean       @default(false)
  name            String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  step            JourneyStep   @default(EMAIL_VERIFICATION)
  confirmed       Boolean       @default(false)
  blocked         Boolean       @default(false)
  username        String?       @unique // Keep in user for auth purposes
  displayUsername String?       @unique // Better Auth username plugin requirement - original case version
  displayName     String? // Keep in user for auth purposes
  firstName       String? // Keep in user for menu/auth purposes
  lastName        String? // Keep in user for menu/auth purposes
  image           String? // Profile image URL - synced from profile
  banExpires      DateTime?
  banReason       String?
  banned          Boolean       @default(false)
  testUser        Boolean       @default(false)
  type            UserType      @default(user)
  role            UserRole      @default(user)
  provider        String        @default("email") // email or google
  lastUnreadEmailSentAt DateTime?   // Track when last unread messages email was sent (24h cooldown)
  lastUsernameChangeAt  DateTime?   // Track last username change for rate limiting (7-day cooldown)
  accounts        Account[]
  chatMemberships ChatMember[]
  chatsCreated    Chat[]
  media           Media[]
  messagesAuthored Message[]     @relation("MessageAuthor")
  messagesDeleted Message[]     @relation("MessageDeletedBy")
  profile         Profile?
  reviewsGiven    Review[]      @relation("ReviewAuthor")
  sessions        Session[]
  blockedUsers    BlockedUser[] @relation("UserBlocks")
  blockedByUsers  BlockedUser[] @relation("BlockedBy")
  savedServices   SavedService[]
  savedProfiles   SavedProfile[]
  emailBatches    EmailBatch[]
  apiKeys         ApiKey[]       @relation("UserApiKeys")

  @@index([role])
  @@index([step])
  @@index([confirmed, blocked])
  @@map("users")
}

model Profile {
  id      String  @id @default(cuid())
  uid     String  @unique
  type    String?
  tagline String?
  taglineNormalized String? // Normalized for accent-insensitive search
  bio     String?
  bioNormalized String? // Normalized for accent-insensitive search
  website String?

  size        String?
  skills      String[] // Array of skill IDs from taxonomy
  speciality  String? // Speciality ID from taxonomy
  category    String? // Service category ID from taxonomy
  subcategory String? // Service subcategory ID from taxonomy

  // Fields moved from User table
  username    String? // Duplicated from User for profile purposes
  displayName String? // Duplicated from User for profile purposes
  displayNameNormalized String? // Normalized for accent-insensitive search
  firstName   String? // Moved from User
  lastName    String? // Moved from User
  email       String? // Duplicated from User for profile purposes
  phone       String? // Moved from User
  /// [Coverage]
  coverage    Json? // Coverage options and location data
  coverageNormalized String? // Normalized coverage location names for search

  // Media fields for onboarding form
  image     String? // Profile image URL
  /// [Portfolio]
  portfolio Json? // Portfolio media CloudinaryResource array

  // Presentation fields
  /// [VisibilitySettings]
  visibility Json? // Visibility settings {email, phone, address}
  /// [SocialMedia]
  socials    Json? // Social media links {facebook, instagram, linkedin, x, youtube, github, behance, dribbble}
  viber      String? // Viber contact
  whatsapp   String? // WhatsApp contact

  //  Additional fields
  rate              Int?
  commencement      String?
  experience        Int?
  contactMethods    String[]
  paymentMethods    String[]
  settlementMethods String[]
  budget            String?
  industries        String[]
  terms             String?
  /// [BillingInfo]
  billing           Json? // Billing information {receipt: boolean, invoice: boolean, afm: string, doy: string, name: string, profession: string, address: string}

  // Rate limiting fields
  lastServiceDraft DateTime? // Last time user saved a service draft
  lastServiceRefreshDate  DateTime? // Last date when any service was refreshed
  dailyServiceRefreshCount Int @default(0) // Count of unique services refreshed today

  verified        Boolean              @default(false)
  featured        Boolean              @default(false)
  rating          Float                @default(0)
  reviewCount     Int                  @default(0)
  /// [StarBreakdown]
  stars           Json? // Rating star breakdown {1: 5, 2: 10, 3: 15, 4: 20, 5: 50}
  top             Boolean              @default(false) // Top level freelancer flag
  published       Boolean              @default(false)
  isActive        Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  user            User                 @relation(fields: [uid], references: [id], onDelete: Cascade)
  reviews         Review[]             @relation("ReviewReceiver")
  services        Service[]
  verification    ProfileVerification?
  savedBy         SavedProfile[]
  subscription    Subscription?

  // ============================================================================
  // OPTIMIZED INDEXES (Performance Optimization - ML15-25)
  // ============================================================================

  // Keep existing essential indexes
  @@index([uid]) // User to profile lookup
  @@index([displayNameNormalized]) // Search functionality
  @@index([coverageNormalized]) // Coverage/location search functionality

  // NEW: Composite indexes for common query patterns (60-70% faster queries)

  // Profile directory with taxonomy + status filters + sorting
  @@index([category, subcategory, published, isActive, rating]) // Main directory query

  // All profiles page with verification filter
  @@index([published, isActive, verified, rating]) // General profile listings

  // Home page featured profiles (sorted by rating)
  @@index([featured, published, isActive, rating]) // Featured profile queries

  // Verified professionals by category
  @@index([verified, published, isActive, category]) // Verified listings

  // REMOVED redundant indexes (covered by composite indexes above):
  // @@index([published, featured]) - covered by featured/published/isActive/rating
  // @@index([verified, rating]) - covered by published/isActive/verified/rating
  // @@index([category, subcategory]) - covered by category/subcategory/published/isActive/rating
  // @@index([published, featured, verified]) - covered by multiple composites above

  @@map("profiles")
}

model ProfileVerification {
  id        String   @id @default(cuid())
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  afm       String? // Greek Tax ID (AFM)
  name      String? // Full business/personal name
  address   String? // Business address
  phone     String? // Contact phone
  uid       String // User ID reference
  pid       String   @unique // Profile ID reference
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile Profile @relation(fields: [pid], references: [id], onDelete: Cascade)

  @@index([uid])
  @@index([pid])
  @@index([status])
  @@map("verifications")
}

enum UserRole {
  user
  freelancer
  company
  admin
  support
  editor
}

enum UserType {
  user
  pro
}

enum JourneyStep {
  EMAIL_VERIFICATION
  TYPE_SELECTION
  OAUTH_SETUP
  ONBOARDING
  DASHBOARD
}
