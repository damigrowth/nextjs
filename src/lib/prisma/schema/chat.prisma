model Chat {
  id            String       @id @default(cuid())
  name          String?
  published     Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  creatorUid    String
  lastMessageId String?      @unique
  lastActivity  DateTime     @default(now())
  members       ChatMember[]
  creator       User         @relation(fields: [creatorUid], references: [id])
  lastMessage   Message?     @relation("ChatLastMessage", fields: [lastMessageId], references: [id])
  messages      Message[]    @relation("ChatMessages")

  @@index([creatorUid])
  @@index([published, createdAt])
  @@index([lastMessageId])
  @@index([lastActivity])
  @@map("chats")
}

model ChatMember {
  chatId   String
  uid      String
  joinedAt DateTime @default(now())
  lastSeen DateTime @default(now())
  muted    Boolean  @default(false)
  online   Boolean  @default(false)
  chat     Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [uid], references: [id], onDelete: Cascade)

  @@id([chatId, uid])
  @@index([uid])
  @@index([online, lastSeen])
  @@map("chat_members")
}

model Message {
  id            String        @id @default(cuid())
  content       String
  read          Boolean       @default(false)
  published     Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  authorUid     String
  chatId        String
  deleted       Boolean       @default(false)
  deletedAt     DateTime?
  deletedBy     String?
  edited        Boolean       @default(false)
  editedAt      DateTime?
  replyToId     String?
  lastMessageOf Chat?         @relation("ChatLastMessage")
  readBy        MessageRead[]
  author        User          @relation("MessageAuthor", fields: [authorUid], references: [id])
  chat          Chat          @relation("ChatMessages", fields: [chatId], references: [id], onDelete: Cascade)
  deletedByUser User?         @relation("MessageDeletedBy", fields: [deletedBy], references: [id])
  replyTo       Message?      @relation("MessageReplies", fields: [replyToId], references: [id])
  replies       Message[]     @relation("MessageReplies")

  @@index([authorUid])
  @@index([chatId, createdAt])
  @@index([deleted, createdAt])
  @@index([replyToId])
  @@map("messages")
}

model MessageRead {
  messageId String
  uid       String
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [uid], references: [id], onDelete: Cascade)

  @@id([messageId, uid])
  @@index([uid])
  @@map("message_reads")
}

model BlockedUser {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  blocker   User     @relation("UserBlocks", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocked_users")
}
